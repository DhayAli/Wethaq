{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البحث داخل مركز</title>
    <style>
        .back-home-btn {
            display: inline-block;
            padding: 8px 15px;
            background-color: #4d6a5e;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 1rem;
            text-align: center;
            transition: background-color 0.3s ease;
            position: fixed;
            bottom: 70px;
            left: 40px;
        }

        .back-home-btn:hover {
            background-color: #3b5447;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
        }

        header {
            background-color: #4d6a5e;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 1.8rem;
            font-weight: bold;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .content {
            margin-top: 100px;
            padding: 20px;
        }

        .search-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .search-container select,
        .search-container input {
            width: 30%;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            outline: none;
            margin: 5px;
        }

        .search-container input {
            width: 50%;
        }

        .search-container button {
            padding: 10px 20px;
            font-size: 1rem;
            background-color: #4d6a5e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .results-container {
            margin-top: 20px;
            direction: rtl;
        }

        .result-header,
        .result-item {
            display: grid;
            grid-template-columns: 1fr 3fr 2fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .result-header {
            background-color: #4d6a5e;
            color: white;
            font-weight: bold;
        }

        .result-item {
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .result-actions button,
        .popup button {
            padding: 10px 20px;
            font-size: 1rem;
            background-color: #4d6a5e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            text-align: right;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        footer {
            background-color: #4d6a5e;
            color: white;
            text-align: center;
            padding: 10px;
            position: fixed;
            bottom: 0;
            width: 100%;
            font-size: 0.9rem;
        }
        /* Logo styles */
.wethaq-logo {
    position: absolute;
    top: -7px;
    right: 20px;
    height: 90px;
    width: auto;
    transition: transform 0.3s ease;
}

.wethaq-logo:hover {
    transform: scale(1.1);
}
    </style>
</head>

<body>
    <header>البحث داخل مركز
         <!-- شعار وثاق -->
         <a href= "{% url 'observer_dashboard' %}">
            <img src="{% static 'images/WethaqLogo.png' %}" class="wethaq-logo" alt="شعار وثاق">
        </a> 
    </header>
 
    <div class="content">
        <div class="search-container">
            <select id="centerSelect" onchange="filterByCenter()">
                <option value="">اختر المركز</option>
            </select>
            <input type="text" id="searchInput" placeholder="اكتب كلمة البحث هنا..." onkeypress="handleKeyPress(event)">
            <button onclick="performSearch()">بحث</button>
        </div>

        <div class="results-container" id="resultsContainer">
            <div class="result-header">
                <div>رقم الملف</div>
                <div>اسم السجين</div>
                <div>الحالة</div>
                <div>الإجراءات</div>
            </div>
            <div id="resultsData"></div>
        </div>

        <div class="popup-overlay" id="popupOverlay" onclick="closePopup(event)">
            <div class="popup" onclick="event.stopPropagation()">
                <h3>تفاصيل السجين</h3>
                <p id="caseDetails"></p>
                <button onclick="closePopup()">إغلاق</button>
            </div>
        </div>
    </div>
    <a href="{% url 'observer_dashboard' %}" class="back-home-btn">⬅</a>
    <footer>
        جميع الحقوق محفوظة © وثاق 2024
    </footer>
    <script>
        // تعريف المتغير كمتغير عمومي
        let casesData = [];
    
        document.addEventListener("DOMContentLoaded", async function () {
            await fetchCenters();
            await fetchCases();
        });
    
        // جلب التوكن من localStorage
        const token = localStorage.getItem("token");
        const headers = {
            "Authorization": `Token ${token}`,
            "Content-Type": "application/json"
        };
    
        function fetchCenters() {
            fetch("https://wethaq-backend.vercel.app/api/centers/", { headers })
                .then(response => {
                    if (!response.ok) throw new Error(`Error: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    const centerSelect = document.getElementById("centerSelect");
                    centerSelect.innerHTML = '<option value="">اختر المركز</option>';
                    data.forEach(center => {
                        centerSelect.innerHTML += `<option value="${center.name}">${center.name}</option>`;
                    });
                })
                .catch(error => console.error("Error fetching centers:", error));
        }
    
        async function fetchCases() {
            if (!token) return;
    
            try {
                const response = await fetch("https://wethaq-backend.vercel.app/api/cases/", { headers });
    
                if (response.status === 401) {
                    alert("التوكن غير صالح. الرجاء تسجيل الدخول مرة أخرى.");
                    localStorage.removeItem("token");
                    return;
                }
    
                if (!response.ok) throw new Error(`Error: ${response.status}`);
    
                // تعيين البيانات إلى المتغير العمومي
                casesData = await response.json();
            } catch (error) {
                console.error("Error fetching cases:", error);
            }
        }
    
        async function performSearch() {
            const searchTerm = document.getElementById("searchInput").value.trim();
            const resultsData = document.getElementById("resultsData");
            resultsData.innerHTML = ""; // مسح النتائج السابقة
    
            if (!searchTerm) {
                resultsData.innerHTML = "<p>الرجاء إدخال نص للبحث.</p>";
                return;
            }
    
            try {
                const response = await fetch(`https://wethaq-backend.vercel.app/api/cases/?search=${searchTerm}`, { headers });
    
                if (response.status === 401) {
                    alert("التوكن غير صالح. الرجاء تسجيل الدخول مرة أخرى.");
                    localStorage.removeItem("token");
                    return;
                }
    
                const data = await response.json();
                console.log("Fetched data:", data); // تأكد من أن البيانات موجودة
    
                let results = data || []; // تفادي undefined
    
                if (results.length === 0) {
                    resultsData.innerHTML = "<p>لا توجد نتائج مطابقة.</p>";
                    return;
                }
    
                results.forEach(caseItem => {
                    const resultItem = document.createElement("div");
                    resultItem.className = "result-item";
                    resultItem.innerHTML = `
                        <div>${caseItem.case_number}</div>
                        <div>${caseItem.detainee?.name || "غير متوفر"}</div>
                        <div>${convertStatusToArabic(caseItem.status)}</div>
                        <div class="result-actions">
                            <button onclick="showPopup(${caseItem.id})">عرض</button>
                        </div>
                    `;
                    resultsData.appendChild(resultItem);
                });
            } catch (error) {
                console.error("Error fetching data:", error);
                resultsData.innerHTML = "<p>حدث خطأ أثناء جلب البيانات. الرجاء المحاولة لاحقًا.</p>";
            }
        }
    
        function filterByCenter() {
            const selectedCenter = document.getElementById("centerSelect").value;
            const resultsData = document.getElementById("resultsData");
            resultsData.innerHTML = ""; // مسح النتائج السابقة
    
            if (!selectedCenter) {
                resultsData.innerHTML = "<p>الرجاء اختيار مركز.</p>";
                return;
            }

            // تأخير تنفيذ الفلترة للتأكد من أن البيانات قد تم تحميلها
            setTimeout(() => {
                const filteredResults = casesData.filter(caseItem => caseItem.center.name === selectedCenter);
    
                if (filteredResults.length === 0) {
                    resultsData.innerHTML = "<p>لا توجد نتائج مطابقة.</p>";
                    return;
                }
    
                filteredResults.forEach(caseItem => {
                    const resultItem = document.createElement("div");
                    resultItem.className = "result-item";
                    resultItem.innerHTML = `
                        <div>${caseItem.case_number}</div>
                        <div>${caseItem.detainee?.name || "غير متوفر"}</div>
                        <div>${convertStatusToArabic(caseItem.status)}</div>
                        <div class="result-actions">
                            <button onclick="showPopup(${caseItem.id})">عرض</button>
                        </div>
                    `;
                    resultsData.appendChild(resultItem);
                });
            }, 100); // تأخير بسيط للتأكد من تحميل البيانات
        }
    
        function showPopup(id) {
            const caseDetails = casesData.find(item => item.id === id);
            if (!caseDetails) {
                console.error("Case not found:", id);
                return;
            }
    
            const popupContent = `
                <p><strong>رقم الهوية:</strong> ${caseDetails.detainee?.id_number || 'غير متوفر'}</p>
                <p><strong>الاسم الثلاثي:</strong> ${caseDetails.detainee?.name || 'غير متوفر'}</p>
                <p><strong>نوع الهوية:</strong> ${convertIdTypeToArabic(caseDetails.detainee?.id_type) || 'غير متوفر'}</p>
                <p><strong>الجنسية:</strong> ${caseDetails.detainee?.nationality || 'غير متوفر'}</p>
                <p><strong>تاريخ الميلاد:</strong> ${caseDetails.detainee?.birth_date || 'غير متوفر'}</p>
                <p><strong>التهمة:</strong> ${caseDetails.charge || 'غير متوفر'}</p>
                <p><strong>المركز:</strong> ${caseDetails.center?.name || 'غير متوفر'}</p>
                <p><strong>تاريخ القبض:</strong> ${caseDetails.arresting_date || 'غير متوفر'}</p>
                <p><strong>مكان القبض:</strong> ${caseDetails.arresting_place || 'غير متوفر'}</p>
                <p><strong>تاريخ التسجيل:</strong> ${formatDate(caseDetails.created_at)}</p>
                <p><strong>الحالة:</strong> ${convertStatusToArabic(caseDetails.status)}</p>
                <p><strong>الوضع الحالي:</strong> ${convertStatusToArabic(caseDetails.detainee_status)}</p>
            `;
    
            document.getElementById("caseDetails").innerHTML = popupContent;
            document.getElementById("popupOverlay").style.display = "flex";
        }
    
        function closePopup() {
            document.getElementById("popupOverlay").style.display = "none";
        }
    
        function convertStatusToArabic(status) {
            const statusMap = {
                'under_investigation': 'قيد التحقيق',
                'in_court': 'في المحكمة',
                'judgment_issued': 'صدر الحكم',
                'in_prison': 'في السجن',
                'released': 'تم الإفراج عنه',
                'under_review': 'قيد المراجعة',
                'imprisoned': 'في السجن'
            };
            return statusMap[status] || 'غير معروف';
        }

        function convertIdTypeToArabic(idType) {
            const idTypeMap = {
    'civil_registry': 'السجل المدني',
    'resident_id': 'هوية مقيم',
    'violator_refugee_id': 'هوية مخالف لاجئ',
    'replacement_card': 'بطاقة بديلة'
};
            return idTypeMap[idType] || 'غير معروف';
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return new Date(dateString).toLocaleDateString('ar-EG', options);
        }
    
        function handleKeyPress(event) {
            if (event.key === "Enter") {
                performSearch(); // تشغيل البحث عند الضغط على Enter
            }
        }
    </script>
</body>

</html>